<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    Fore more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="A new Flutter project.">

  <!-- iOS meta tags & icons -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="dinodino_nirvana">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>dinodino_nirvana</title>
  <link rel="manifest" href="manifest.json">

  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.2.0/exceljs.min.js" integrity="sha512-3ZnqnLCRnyAXG2Hbb0v+DNzl5QYyRocJeG7Uwy5qBausA0jB5cLSZ4gHWHkbINJIyWU3vApjCwH1rNO4XEn9SQ==" crossorigin="anonymous"></script>
</head>
<body>
  <!-- This script installs service_worker.js to provide PWA functionality to
       application. For more information, see:
       https://developers.google.com/web/fundamentals/primers/service-workers -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('flutter-first-frame', function () {
        navigator.serviceWorker.register('flutter_service_worker.js?v=2393284282');
      });
    }
  </script>

  <script>
    var rules = {};

    function uploadFile() {
      var input = document.createElement('input');
      input.type = 'file';
      input.multiple = 'false';
      input.accept = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      input.style='display:none';
      input.addEventListener('change', handleFile, false);
      document.body.appendChild(input);
      input.click();
      document.body.removeChild(input);
    }

    function handleFile(e) {
      var files = e.target.files, f = files[0];
      var reader = new FileReader();
      reader.onload = async (e) => {
        let buffer = reader.result;
        const wb = new ExcelJS.Workbook();
        wb.xlsx.load(buffer).then(async workbook => {
          workbook.eachSheet((sheet, id) => {
            sheet.columns.forEach((col) => {
              col.eachCell((cell, rowIndex) => {
                if(cell.value != null && cell.value.startsWith != null) {
                  if(cell.value.startsWith('&')) {
                    cell.value = formatString(cell.value.substring(1));
                  }
                }
              })
            });
          });

          const buf = await workbook.xlsx.writeBuffer();
          let a = document.createElement('a');
          let data = new Blob([buf], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
          let url = URL.createObjectURL(data);
          a.href = url;
          a.download = 'export.xlsx';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });
      }
      reader.readAsArrayBuffer(f);
    }

    function formatString(format) {
      format = format.split('#');
      if(format.length != 2) return '';
      let projection = format[0];
      let where = format[1];

      where = where.split('_');
      if(where.length < 0 || where.length > 3) return '';
      where = where.map(e => {
        let l = e.split('-');
        return l.map(v => parseInt(v, 10));
      });
      if(where.some(e => e.some(v => isNaN(v)))) return '';
      if(where.some(e => e.length > 2)) return '';
      where.forEach(e => {
        if(e.length == 1) e.push(e[0]);
      });

      let target = [rules];
      if(where.length > 0) {
        if(target.some(e => e.rules.length <= where[0][1])) return '';
        let t = [];
        target.forEach(e => {
          t.push(...e.rules.slice(where[0][0], where[0][1]+1));
        });
        target = t;
      }
      if(where.length > 1) {
        if(target.some(e => e.courseList.length <= where[1][1])) return '';
        let t = [];
        target.forEach(e => {
          t.push(...e.courseList.slice(where[1][0], where[1][1]+1));
        });
        target = t;
      }
      if(where.length > 2) {
        if(target.some(e => e.courses.length <= where[2][1])) return '';
        let t = [];
        target.forEach(e => {
          t.push(...e.courses.slice(where[2][0], where[2][1]+1));
        })
        target = t;
      }

      let t = [];
      target.forEach(e => { if(e != null) t.push(e); });
      target = t;
      console.log(target);
      if(!target.length) return '';
      
      if(where.length == 0) {
        let totalCredit = target.reduce((acc, val) => acc + val.totalCredit, 0);
        let title = target[0].title;

        projection = projection.replaceAll('{name}', title);
        projection = projection.replaceAll('{credit}', totalCredit.toString());
      } else if(where.length == 1) {
        let totalCredit = target.reduce((acc, val) => acc + val.totalCredit, 0);
        let title = target[0].title;

        projection = projection.replaceAll('{name}', title);
        projection = projection.replaceAll('{credit}', totalCredit.toString());
      } else if(where.length == 2) {
        let totalCredit = target.reduce((acc, val) => acc + val.totalCredit, 0);
        let title = target[0].title;

        projection = projection.replaceAll('{name}', title);
        projection = projection.replaceAll('{credit}', totalCredit.toString());
      } else {
        let totalCredit = target.reduce((acc, val) => acc + val.credit, 0);
        
        projection = projection.replaceAll('{name}', target[0]['name']);
        projection = projection.replaceAll('{year}', target[0]['year'].toString());
        projection = projection.replaceAll('{semester}', target[0]['semester'].toString());
        projection = projection.replaceAll('{category}', target[0]['category']);
        projection = projection.replaceAll('{department}', target[0]['department']);
        projection = projection.replaceAll('{credit}', totalCredit.toString());
        projection = projection.replaceAll('{score}', (target[0]['score'] != -1 ? target[0]['score'].toString() : target[0]['grade'] != ' ' ? target[0]['grade'] : '尚無資料'));
        projection = projection.replaceAll('{grade}', target[0]['grade']);
        projection = projection.replaceAll('{teacher}', target[0]['teacher']);
        projection = projection.replaceAll('{additionalInfo}', target[0]['additionalInfo']);
      }
      return projection;
    }

    function handleXLSX(rule) {
      rules = JSON.parse(rule);
      uploadFile();

    }
  </script>
  <script src="main.dart.js" type="application/javascript"></script>

</body>
</html>
